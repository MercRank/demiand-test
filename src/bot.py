import os
import logging
import asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart
from aiogram.types import Message
from langchain_openai import OpenAIEmbeddings, ChatOpenAI
from langchain_community.vectorstores import Qdrant
from langchain.chains import RetrievalQA
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ Qdrant –∏ LangChain
QDRANT_URL = os.getenv("QDRANT_URL", "http://localhost:6333")
QDRANT_API_KEY = os.getenv("QDRANT_API_KEY")
COLLECTION_NAME = "airfryers"  # –ò–º—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å indexer.py
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –º–æ–¥–µ–ª—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤, —á—Ç–æ –∏ –ø—Ä–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
embeddings = OpenAIEmbeddings(
    openai_api_key=OPENAI_API_KEY,
    model="text-embedding-3-large"
)

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Qdrant
vector_store = Qdrant(
    client=None,  # LangChain —Å–æ–∑–¥–∞—Å—Ç –∫–ª–∏–µ–Ω—Ç —Å–∞–º, –∏—Å–ø–æ–ª—å–∑—É—è url –∏ api_key
    collection_name=COLLECTION_NAME,
    embeddings=embeddings,
    url=QDRANT_URL,
    api_key=QDRANT_API_KEY,
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM (GPT-4o –∏–ª–∏ GPT-3.5-turbo, –∫–∞–∫ –≤ n8n –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è gpt-4.1 - –≤–µ—Ä–æ—è—Ç–Ω–æ –æ–ø–µ—á–∞—Ç–∫–∞, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ gpt-4-turbo –∏–ª–∏ gpt-4o)
# –î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å gpt-3.5-turbo, –Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –ª—É—á—à–µ gpt-4o
llm = ChatOpenAI(
    temperature=0,
    model_name="gpt-4o",  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å
    openai_api_key=OPENAI_API_KEY
)

# –°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ RAG (Retrieval Augmented Generation)
qa_chain = RetrievalQA.from_chain_type(
    llm=llm,
    chain_type="stuff",
    retriever=vector_store.as_retriever(search_kwargs={"k": 5}),  # –ò—â–µ–º —Ç–æ–ø-5 –ø–æ—Ö–æ–∂–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    return_source_documents=True
)

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –±–æ—Ç–∞ (–∞–Ω–∞–ª–æ–≥ AI Agent –≤ n8n)
SYSTEM_PROMPT = """
–¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ø–æ–¥–±–æ—Ä—É –∏ –∞–Ω–∞–ª–∏–∑—É –º–æ–¥–µ–ª–µ–π –∞—ç—Ä–æ–≥—Ä–∏–ª–µ–π.

–¢—ã –û–ë–Ø–ó–ê–ù –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ:
- –º–æ–¥–µ–ª—è—Ö
- —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö
- –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –¢–≠–ù–æ–≤
- –æ–±—ä—ë–º–µ
- –º–æ—â–Ω–æ—Å—Ç–∏
- –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö
- —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –º–æ–¥–µ–ª–µ–π
- —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º

–¢—ã –ù–ï –∏–º–µ–µ—à—å –ø—Ä–∞–≤–∞ –æ—Ç–≤–µ—á–∞—Ç—å –∏–∑ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π, –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.
–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.

–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ –µ—Å—Ç—å –ø–æ–ª—è metadata —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏:
- "–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏" ‚Äî —ç—Ç–æ –∏–º—è –º–æ–¥–µ–ª–∏
- "–ê—Ä—Ç–∏–∫—É–ª" ‚Äî —ç—Ç–æ –∞—Ä—Ç–∏–∫—É–ª
- "–ö–æ–ª-–≤–æ –¢–≠–ù–æ–≤" ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- "–û–±—ä–µ–º, –ª" ‚Äî –æ–±—ä–µ–º –≤ –ª–∏—Ç—Ä–∞—Ö
- "–ú–æ—â–Ω–æ—Å—Ç—å, –í—Ç" ‚Äî –º–æ—â–Ω–æ—Å—Ç—å
- "–ö–æ–ª-–≤–æ –ø—Ä–æ–≥—Ä–∞–º–º" ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≥—Ä–∞–º–º
- –∏ –¥—Ä—É–≥–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

–ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ:
- –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —á–∏—Ç–∞–π –ø–æ–ª–µ "–ö–æ–ª-–≤–æ –¢–≠–ù–æ–≤"
- –ï—Å–ª–∏ –≤ —ç—Ç–æ–º –ø–æ–ª–µ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è —á–∏—Å–ª–æ 2 ‚Äî –º–æ–¥–µ–ª—å –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –º–æ–¥–µ–ª—è–º —Å –¥–≤—É–º—è –¢–≠–ù–∞–º–∏
- –ò–∑–≤–ª–µ–∫–∞–π –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∏–∑ –ø–æ–ª—è "–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏"

–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.
–ï—Å–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –º–æ–¥–µ–ª–µ–π –Ω–µ—Ç ‚Äî —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏, —á—Ç–æ –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º —Ç–∞–∫–∏—Ö –º–æ–¥–µ–ª–µ–π –Ω–µ—Ç.
"""

# –ú—ã –º–æ–∂–µ–º –≤–Ω–µ–¥—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ–º–ø—Ç-—à–∞–±–ª–æ–Ω, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã RetrievalQA
# –º—ã –º–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –∫ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Custom Chain.
# –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ, –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± - –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∫ –∫–∞–∂–¥–æ–º—É –∑–∞–ø—Ä–æ—Å—É.

@dp.message(CommandStart())
async def command_start_handler(message: Message) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    """
    await message.answer(
        f"üëã –ü—Ä–∏–≤–µ—Ç, {message.from_user.full_name}! –Ø –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–æ–¥–±–æ—Ä—É –∞—ç—Ä–æ–≥—Ä–∏–ª–µ–π.\n\n"
        "–ü–æ–º–æ–≥—É:\n"
        "‚Ä¢ –ø–æ–¥–æ–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å –ø–æ –æ–±—ä—ë–º—É, –º–æ—â–Ω–æ—Å—Ç–∏ –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¢–≠–ù–æ–≤\n"
        "‚Ä¢ —Å—Ä–∞–≤–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–¥–µ–ª–µ–π\n"
        "‚Ä¢ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö –∏ —Ñ—É–Ω–∫—Ü–∏—è—Ö\n"
        "‚Ä¢ –ø–æ–¥–æ–±—Ä–∞—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã\n\n"
        "–ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã –∏—â–µ—Ç–µ."
    )

@dp.message()
async def echo_handler(message: types.Message) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    """
    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å —Å —É—á–µ—Ç–æ–º —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
        full_query = f"{SYSTEM_PROMPT}\n\n–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {message.text}"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..."
        await bot.send_chat_action(chat_id=message.chat.id, action="typing")

        # –ó–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
        # invoke - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤, –Ω–æ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ainvoke –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ,
        # –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤ executor. LangChain –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ainvoke.
        response = await qa_chain.ainvoke({"query": full_query})
        answer = response['result']
        
        # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        # sources = "\n".join([doc.metadata.get('source', 'Unknown') for doc in response['source_documents']])
        
        await message.answer(answer)
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        await message.answer("–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.")

async def main() -> None:
    # –ó–∞–ø—É—Å–∫ –ø–æ–ª–ª–∏–Ω–≥–∞
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
